{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <title>Horecast</title>

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet" />
  <!-- Google Fonts Roboto -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" />
  <!--axios-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
  <!--cookie-->
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
  <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.1.4/dist/js/tabulator.min.js"></script>
  <!-- Custom styles -->
  <link rel="stylesheet" href="{% static 'css/mdb.min.css' %}" />
  <link rel="stylesheet" href="{% static 'css/admin.css' %}" />
  <link rel="stylesheet" href="{% static 'css/mdb.rtl.min.css' %}" />
  <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}" />
</head>
<body>
  <!--Main Navigation-->
  <header>
    <!-- Sidebar -->
    <nav id="sidebarMenu" class="collapse d-lg-block sidebar" style="background-color: #eeeeee">
      <div class="position-sticky">
        <div class="d-flex align-items-center justify-content-center">
            <img src="{% static 'img/logo.png' %}" style="width:200px;" alt="ロゴ" loading="lazy" />
        </div>
        <div class="list-group list-group-flush mx-3">
          <a href="" type="button" class="btn btn-rounded text-start  d-flex align-items-center justify-content-center fs-5 " style="width: 200px; background-color:#79d1d5;">レベル５</a>
          <br>
          <ul class="sidenav-menu">
            <li class="sidenav-item">
                <a class="sidenav-link" href="{% url 'forecast:index' %}">
                    <i class="fas fa-home me-3"></i><span>Home</span></a>
            </li>
            <li class="sidenav-item">
                <a class="sidenav-link" href="{% url 'forecast:dashboard' %}">
                    <i class="far fa-sticky-note me-3"></i><span>レベル4</span></a>
            </li>
            <li class="sidenav-item">
                <a class="sidenav-link" href="{% url 'forecast:timeline' %}">
                    <i class="far fa-sticky-note me-3"></i><span>レベル5</span></a>
            </li>
          </ul>
          <form action="{% url 'forecast:search' %}" method="POST" id="search">
            {% csrf_token %}
            {{ form.non_field_errors }}
            <table>
              {{ form.as_p }}
            </table>
            <br>
            <div class="text-center">
              <button id="show" type="submit" class="btn fs-6" style="background-color: #79d1d5;">検索</button>
            </div>
          </form>
          <br>
          <br>
          <div class="btn-group">
            <input type="radio" class="btn-check" name="options" id="show_pre" ,autocomplete="off" checked />
            <label class="btn btn-light" for="show_pre" >出馬表</label>
            <input type="radio" class="btn-check" name="options" id="show_lat" , autocomplete="off"/>
            <label class="btn btn-light" for="show_lat" >結果</label>
            <!-- <button id="show_pre"  class="btn active" data-toggle="tab" style="background-color:#18b3bb;">出馬表</button>
            <button id="show_lat"  class="btn" data-toggle="tab" style="background-color:#18b3bb;">結果</button> -->
          </div>
        </div>
      </div>
    </nav>
    <!-- Sidebar -->
  </header>
  <main class="mt-5">
    <div class="container">
      <div class= "card bg-dark text-white" style="width: 81rem; height: 15rem; display: none;" id="race_information">
        <img src="{% static 'img/background.jpg' %}" style="width: 81rem; height: 15rem; opacity: 0.5; filter: grayscale(100%);" class="card-img" alt="..." />
        <div class="card-img-overlay">
            <div class="row">
                <div class="col-6">
                <div class="d-flex">
                    <h1 id="race_park_hold"></h1>
                    <h1 id="race_number_hold"></h1>
                </div>
                <br>
                <h1 id="race_name_hold"></h1>
                <br>
                <div class="d-flex">
                    <h1 id="race_type_hold"></h1>
                    <h1 id="course_len_hold"></h1>
                    <h1 id="race_turn_hold"></h1>
                </div>
                </div>
                <div class="col-6">
                <div class="d-flex">
                    <h1>天候：</h1>
                    <h1 id="weather_hold"></h1>
                </div>
                <br>
                <div class="d-flex">
                    <h1>出走頭数：</h1>
                    <h1 id="n_horses_hold"></h1>
                </div>
                <br>
                <div class="d-flex">
                    <h1>馬場状態：</h1>
                    <h1 id="race_condition_hold"></h1>
                </div>
                </div>
            </div>
        </div>
      </div>
      <br>
      <br>
      <div id="race_card" style="display: none;">
        <div class="card">
          <div class="card-header fs-1" style="background-color: #79d1d5;">出馬表</div>
          <div class="card-body">
            <div id="showData"></div>
          </div>
        </div>
        <br>
        <br>
        <br>
        <div class="card">
          <div class="card-header fs-1" style="background-color: #79d1d5;">軸馬＆紐馬</div>
          <div class="card-body">
            <div id="showBet"></div>
            <br>
            <div id="showHorse">
              <div id="CenterHorse" class="fs-4"></div>
              <br>
              <div id="BetHorse_1" class="fs-4"></div>
              <div id="BetHorse_2" class="fs-4"></div>
              <div id="BetHorse_3" class="fs-4"></div>
              <br>
              <br>
              <div id="recommend"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="row" id="result_card" style="display: none;">
        <div class="card">
          <div class="card-header fs-1" style="background-color: #79d1d5;">レース結果</div>
          <div class="card-body">
            <div id="showResult"></div>
          </div>
        </div>
        <br>
        <br>
        <br>
        <div class="card">
          <div class="card-header fs-1" style="background-color:#79d1d5;">軸馬＆紐馬　結果</div>
          <div class="card-body">
            <div id="showBet"></div>
            <br>
            <div id="showMoney">
              <div id="CenterHorse_r" class="fs-4"></div>
              <br>
              <div id="BetHorse_1_r" class="fs-4"></div>
              <div id="BetHorse_2_r" class="fs-4"></div>
              <div id="BetHorse_3_r" class="fs-4"></div>
              <br>
              <br>
              <div id="result"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <!-- MDB -->
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/3.3.0/mdb.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="{% static 'js/mdb.min.js' %}"></script>
  <link rel="stylesheet" href="{% static 'js/datatable.min.js' %}" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script>
    let form = document.getElementById('search'); // selecting the form 
    $(function () {
        $("#show").on('click', () => {
          $('#result_card').hide();
          $('#race_information').show();
          $('#race_card').show();
        });
    });
    $(function () {
      $("#show_pre").on('click', () => {
        $('#result_card').hide();
        $('#race_card').show();
      });
    });
    $(function () {
      $("#show_lat").on('click', () => {
        $('#race_card').hide();
        $('#result_card').show();
      });
    });
    form.addEventListener('submit', function(event) { // 1
        event.preventDefault()
        
        let data = new FormData(); // 2

        data.append("race_date", document.getElementById("race_date").value)  
        data.append("race_park", document.getElementById("race_park").value)
        data.append("race_number", document.getElementById("race_number").value)
        //data.append("csrfmiddlewaretoken", '{{csrf_token}}') // 3
        axios.defaults.xsrfCookieName = 'csrftoken'
        axios.defaults.xsrfHeaderName = "X-CSRFTOKEN"      
        axios.post('{% url "forecast:search" %}', data)
            .then(function (response){
            res = response.data;
            console.log(res)
            let race_list = Object.entries(res["data_pre"]);
            let result_list = Object.entries(res["data_lat"]);
            let return_list = Object.entries(res["data_re"]);

            console.log(return_list)

            $("#race_park_hold").text(`${race_list[1][1]["race_park"]}`);
            $("#race_number_hold").text(`${race_list[1][1]["race_number"]}R`);
            $("#race_name_hold").text(`${race_list[1][1]["race_name"]}`);
            $("#course_len_hold").text(`${race_list[1][1]["course_len"]}m`);
            $("#n_horses_hold").text(`${race_list[1][1]["n_horses"]}頭`);
            $("#race_condition_hold").text(`${race_list[1][1]["race_condition"]}`);
            $("#race_turn_hold").text(`(${race_list[1][1]["race_turn"]})`);
            $("#race_type_hold").text(`${race_list[1][1]["race_type"]}`);
            $("#weather_hold").text(`${race_list[1][1]["weather"]}`);

            let pred = new Array();
            let center = new Array();
            let bet = new Array();

            for (let i = 0; i < race_list.length; i++) {
                pred.push(race_list[i][1]["pred"]);
                center.push(race_list[i][1]["center"]);
                bet.push(race_list[i][1]["bet"]);
            }
            
            for (let i = 0; i < race_list.length; i++) {
                delete race_list[i][1]["race_date"];
                delete race_list[i][1]["horse_id"];
                delete race_list[i][1]["race_park"];
                delete race_list[i][1]["race_number"];
                delete race_list[i][1]["race_name"];
                delete race_list[i][1]["course_len"];
                delete race_list[i][1]["n_horses"];
                delete race_list[i][1]["race_condition"];
                delete race_list[i][1]["race_turn"];
                delete race_list[i][1]["race_type"];
                delete race_list[i][1]["weather"]; 
                delete race_list[i][1]["pred"];
                delete race_list[i][1]["center"];
                delete race_list[i][1]["bet"];
            }                
            let col = [];
            let th_col_h = ["馬番","馬名","性齢", "騎手名", "斤量"];
            for (let i = 0; i < race_list.length; i++) {
                for (let key in race_list[i][1]) {
                    
                    if (col.indexOf(key) === -1){
                    col.push(key);
                    }
                }
            }
            let table = document.createElement("table");
            table.className = 'table table-striped';
            let tr = table.insertRow(-1); 
            
            for (let i = 0; i < col.length; i++) {
                var th = document.createElement("th");      // TABLE HEADER.
                th.innerHTML = th_col_h[i];
                tr.appendChild(th);
            }
            for (var i = 0; i < race_list.length; i++) {
                tr = table.insertRow(-1);
                for (var j = 0; j < col.length; j++) {
                    var tabCell = tr.insertCell(-1);
                    tabCell.innerHTML = race_list[i][1][col[j]];
                }
            }
            
            let divContainer_Data = document.getElementById("showData");
            divContainer_Data.innerHTML = "";
            divContainer_Data.appendChild(table);
            
            let center_number = center.indexOf(1)
            let bet_numbers = [];
            var idx = bet.indexOf(1);
            while (idx != -1) {
                bet_numbers.push(idx);
                idx = bet.indexOf(1, idx + 1);
            }
            bet_numbers = bet_numbers.filter(function (value){
                return value!=center_number
            })
            let message = document.createElement("h2");
            if (pred.every(x => x == 1)){
                message.innerHTML = "このレースは購入推奨外レースです"
            }else{
                message.innerHTML = "このレースの軸及び相手は次の通りです";
            } 
            let divContainer_Bet = document.getElementById("showBet");
            divContainer_Bet.innerHTML = "";
            divContainer_Bet.appendChild(message);
            if (pred.every(x => x == 1)) {
              $('#showHorse').hide();
            } else {
              $('#showHorse').show();
              $("#CenterHorse").text(`【軸】${race_list[center_number][1]["horse_number"]}:${race_list[center_number][1]["horse_name"]}`);
              $("#BetHorse_1").text(`【相手１頭目】${race_list[bet_numbers[0]][1]["horse_number"]}:${race_list[bet_numbers[0]][1]["horse_name"]}`);
              $("#BetHorse_2").text(`【相手２頭目】${race_list[bet_numbers[1]][1]["horse_number"]}:${race_list[bet_numbers[1]][1]["horse_name"]}`);
              $("#BetHorse_3").text(`【相手３頭目】${race_list[bet_numbers[2]][1]["horse_number"]}:${race_list[bet_numbers[2]][1]["horse_name"]}`);
            
              const recommend_table=`<table class="table" id="recommend_table_id">
                                      <thead style="background-color:#79d1d5;">
                                        <tr>
                                          <th class="fs-5">券種</th>
                                          <th class="fs-5">軸</th>
                                          <th class="fs-5">相手</th>
                                          <th class="fs-5">結果</th>
                                        </tr>
                                      </thead>
                                        <tbody id="recommend_table"><?=$view?>
                                        </tbody>
                                      </table>` 
              const umaren = `<tr><td class="fs-5">馬連(ながし)</td><td class="fs-5">${race_list[center_number][1]["horse_number"]}</td><td class="fs-5">${race_list[bet_numbers[0]][1]["horse_number"]},${race_list[bet_numbers[1]][1]["horse_number"]},${race_list[bet_numbers[2]][1]["horse_number"]}</td><td class="fs-5"></td>`;
              const sannrennpuku = `<tr><td class="fs-5">三連複(ながし)</td><td class="fs-5">${race_list[center_number][1]["horse_number"]}</td><td class="fs-5">${race_list[bet_numbers[0]][1]["horse_number"]},${race_list[bet_numbers[1]][1]["horse_number"]},${race_list[bet_numbers[2]][1]["horse_number"]}</td><td class="fs-5"></td>`;
              $("#recommend").html(recommend_table)
              $("#recommend_table_id").find("#recommend_table").append(umaren);
              $("#recommend_table_id").find("#recommend_table").append(sannrennpuku);
            }
            let col_r = [];
            let th_col_hr = ["着順","馬番", "馬名", "性齢", "騎手名", "斤量", "人気", "オッズ"];
            for (let i = 0; i < result_list.length; i++) {
              for (let key in result_list[i][1]) {

                if (col_r.indexOf(key) === -1) {
                  col_r.push(key);
                }
              }
            }
            let result = document.createElement("table");
            result.className = 'table table-striped';
            let tr_r = result.insertRow(-1);

            for (let i = 0; i < col_r.length; i++) {
              var th_r = document.createElement("th");      // TABLE HEADER.
              th_r.innerHTML = th_col_hr[i];
              tr_r.appendChild(th_r);
            }
            const rank_list = []
            for (let i = 0; i < result_list.length; i++) {
              rank_list.push(result_list[i][1])
            }
            rank_list.sort(function (a, b) {
                if (a.rank < b.rank) return -1;
                if (a.rank > b.rank) return 1;
                return 0;
            });
            console.log(rank_list);
            for (var i = 0; i < rank_list.length; i++) {
              tr_r = result.insertRow(-1);
              for (var j = 0; j < col_r.length; j++) {
                var tabCell_r = tr_r.insertCell(-1);
                tabCell_r.innerHTML = rank_list[i][col_r[j]];
                ;
              }
            }
            
            let divContainer_Result = document.getElementById("showResult");
            divContainer_Result.innerHTML = "";
            divContainer_Result.appendChild(result);
            if (pred.every(x => x == 1)) {
              $('#showMoney').hide();
            } else {
              $('#showMoney').show();
              $("#CenterHorse_r").text(`【軸馬】${race_list[center_number][1]["horse_number"]}:${race_list[center_number][1]["horse_name"]}(${result_list[center_number][1]["favorite"]}人気)  ${result_list[center_number][1]["rank"]}着`);
              $("#BetHorse_1_r").text(`【紐馬１頭目】${race_list[bet_numbers[0]][1]["horse_number"]}:${race_list[bet_numbers[0]][1]["horse_name"]}(${result_list[bet_numbers[0]][1]["favorite"]}人気)  ${result_list[bet_numbers[0]][1]["rank"]}着`);
              $("#BetHorse_2_r").text(`【紐馬２頭目】${race_list[bet_numbers[1]][1]["horse_number"]}:${race_list[bet_numbers[1]][1]["horse_name"]}(${result_list[bet_numbers[1]][1]["favorite"]}人気)  ${result_list[bet_numbers[1]][1]["rank"]}着`);
              $("#BetHorse_3_r").text(`【紐馬３頭目】${race_list[bet_numbers[2]][1]["horse_number"]}:${race_list[bet_numbers[2]][1]["horse_name"]}(${result_list[bet_numbers[2]][1]["favorite"]}人気)  ${result_list[bet_numbers[2]][1]["rank"]}着`);

              const recommend_table = `<table class="table" id="result_table_id">
                                      <thead style="background-color:#79d1d5;">
                                        <tr>
                                          <th class="fs-5">券種</th>
                                          <th class="fs-5">軸</th>
                                          <th class="fs-5">相手</th>
                                          <th class="fs-5">結果</th>
                                        </tr>
                                      </thead>
                                        <tbody id="result_table"><?=$view?>
                                        </tbody>
                                      </table>`
              const umaren = `<tr><td class="fs-5">馬連(ながし)</td><td class="fs-5">${race_list[center_number][1]["horse_number"]}</td><td class="fs-5">${race_list[bet_numbers[0]][1]["horse_number"]},${race_list[bet_numbers[1]][1]["horse_number"]},${race_list[bet_numbers[2]][1]["horse_number"]}</td><td class="fs-5">${return_list[0][1]["umaren"]}円</td>`;
              const sannrennpuku = `<tr><td class="fs-5">三連複(ながし)</td><td class="fs-5">${race_list[center_number][1]["horse_number"]}</td><td class="fs-5">${race_list[bet_numbers[0]][1]["horse_number"]},${race_list[bet_numbers[1]][1]["horse_number"]},${race_list[bet_numbers[2]][1]["horse_number"]}</td><td class="fs-5">${return_list[0][1]["sanrenpuku"]}円</td>`;
              $("#result").html(recommend_table)
              $("#result_table_id").find("#result_table").append(umaren);
              $("#result_table_id").find("#result_table").append(sannrennpuku);
            }

            }) // 5
            .catch(errors => console.log(errors)) // 6
    })
  </script>
</body>
</html>